#!/bin/bash

TEMP="/tmp/rutasNuevas.txt"
if [ ! -f $TEMP ]; then touch $TEMP; fi
if [ "$(whoami)" != "root" ]; then sudo $0 $*; fi
while true; do
   for i in 22 25; do
      if [ "$(ping -c 4 10.$i.$i.$i 2>&1 | grep '100% packet loss' | grep -v grep)" != "" ]; then
         IP_TOR="$(tcpdump -c 1 -i wlan20 -n dst port 443 | awk '{print $3}' | awk -F'.' '{print $1"."$2"."$3"."$4;}')"
         echo $IP_TOR entrante
         if [ "$(route -n | grep $IP_TOR)" = "" ]; then # -a "$(wget -O - http://$IP_TOR/ 2>/dev/null | grep Tor)" != "" ]; then
            eecho sudo route add -host $IP_TOR gw r1
            ping -c 4 $IP_TOR
            if [ "$(cat $TEMP | grep $IP_TOR)" = "" ]; then
               echo $IP_TOR >> $TEMP
            fi
         fi
      fi
   done
   sleep 20
   TEMP2=$(tempfile)
   while read IP_TOR; do 
      if [ "$(sudo netstat -onatup | grep sslh | grep $IP_TOR | grep -v grep)" = "" ]; then
         echo sudo route del -host $IP_TOR
      else
         echo $IP_TOR >> $TEMP2
      fi
   done < $TEMP 
   rm $TEMP
   mv $TEMP2 $TEMP   
done
