#!/bin/bash
uso() {
   echo $0 '<dir-dvd> <fichero-avi> [capitulo inicial [capitulo final]] '
   exit -1
}
   

if [ "$1" = "" -o "$2" = "" ];
then
   uso
fi   
CARPETA_ORIGEN=$1
SALIDA=$2
echo Hora Comienzo: > tiempo.txt
date >> tiempo.txt
echo Hora Comienzo: 
date 
WORKDIR=./
cd $WORKDIR
NUMTITLES=$(mplayer -dvd-device $CARPETA_ORIGEN dvd:// -identify -endpos 0 -vo null -vc null -ao null -nosound 2> /dev/null | grep ID_DVD_TITLES= | cut -d "=" -f 2  )
echo Total TÃ­tulos Encontrados $NUMTITLES
hablaf Total Titulos Encontrados $NUMTITLES
mencoder -aspect 16:9 -vf cropdetect,scale -zoom -xy 640 dvd:// -dvd-device $CARPETA_ORIGEN -oac copy -ovc xvid -xvidencopts bitrate=600 -o prueba.avi -ss 00:05:00 -endpos 60 > prueba.txt
CROP=$(cat prueba.txt | grep -i crop | grep -i area | tail -n 1 | gawk -F= '{ print $2; }' |  gawk -F')' '{print $1;}')
echo mencoder -aspect 16:9 -vf crop=$CROP,scale -zoom -xy 640 dvd:// -dvd-device $CARPETA_ORIGEN -o $SALIDA.avi -oac mp3lame -lameopts cbr:br=128:vol=1.25 -ovc xvid -xvidencopts bitrate=1300 -alang es -noskip

if [ "$3" = "" ];
then  
   i=1
else
   i=$3
fi      
if [ "$4" = "" ];
then
   FIN=$NUMTITLES
else
   FIN=$4
fi      
while [ $i -le $NUMTITLES ];
#for((i=1;i<=$FIN;i++));
do
   if [ $i -lt 10 ];
   then
      TITLE=0$i
   else
      TITLE=$i
   fi
   echo    mencoder -aspect 16:9 -vf crop=$CROP,scale -zoom -xy 640 dvd://$TITLE -dvd-device $CARPETA_ORIGEN -o $SALIDA-$TITLE.avi -oac mp3lame -lameopts cbr:br=128:vol=1.25 -ovc xvid -xvidencopts bitrate=1300 -alang es  -ni

   mencoder -aspect 16:9 -vf crop=$CROP,scale -zoom -xy 640 dvd://$TITLE -dvd-device $CARPETA_ORIGEN -o $SALIDA-$TITLE.avi -oac mp3lame -lameopts cbr:br=128:vol=1.5 -ovc xvid -xvidencopts bitrate=1300 -alang es  -ni
   INGLES=$(mplayer -dvd-device /media/cdrom0 dvd:// -identify -endpos 0 -vo null -vc null -ao null -nosound 2> /dev/null | grep -i aid | grep -i en)
   if [ "$INGLES" != "" ];
   then
      mencoder -ovc frameno -of rawaudio -oac mp3lame -lameopts cbr:br=128:vol=1.5 -alang en  -o $SALIDA-$TITLE.eng.mp3  dvd://$TITLE -dvd-device $CARPETA_ORIGEN
   fi
   i=$(expr $i + 1)
done
echo Hora Fin: >> tiempo.txt
date >> tiempo.txt
echo Hora Fin: 
date 
rm prueba.*

